"use strict";(self.webpackChunksaurus=self.webpackChunksaurus||[]).push([[5587],{3302:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"developer-guide/projects/otk/omnifest/directive","title":"Directive","description":"In omnifests directives are sections of the document that get transformed by otk into something else.","source":"@site/docs/developer-guide/02-projects/otk/03-omnifest/01-directive.md","sourceDirName":"developer-guide/02-projects/otk/03-omnifest","slug":"/developer-guide/projects/otk/omnifest/directive","permalink":"/docs/developer-guide/projects/otk/omnifest/directive","draft":false,"unlisted":false,"editUrl":"https://github.com/osbuild/osbuild.github.io/tree/main/docs/developer-guide/02-projects/otk/03-omnifest/01-directive.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"developer","previous":{"title":"Omnifest","permalink":"/docs/developer-guide/projects/otk/omnifest/"},"next":{"title":"External","permalink":"/docs/developer-guide/projects/otk/omnifest/external"}}');var s=i(4848),o=i(8453);const r={},d="Directive",l={},c=[{value:"<code>otk.version</code>",id:"otkversion",level:2},{value:"Example",id:"example",level:3},{value:"<code>otk.target.&lt;consumer&gt;.&lt;name&gt;</code>",id:"otktargetconsumername",level:2},{value:"<code>otk.define</code>",id:"otkdefine",level:2},{value:"Usage of <code>${}</code>",id:"usage-of-",level:2},{value:"<code>otk.include</code>",id:"otkinclude",level:2},{value:"<code>otk.op</code>",id:"otkop",level:2},{value:"<code>otk.op.join</code>",id:"otkopjoin",level:3},{value:"<code>otk.external</code>",id:"otkexternal",level:2}];function a(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"directive",children:"Directive"})}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"/docs/developer-guide/projects/otk/omnifest/",children:"omnifests"})," directives are sections of the document that get transformed by ",(0,s.jsx)(n.code,{children:"otk"})," into something else."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"otk"})," has various directives that can be used in an omnifest. Generally these directives can appear anywhere in the tree unless otherwise specified (see below) and they are replaced with other trees or values as produced by the directive."]}),"\n",(0,s.jsxs)(n.p,{children:["There are ",(0,s.jsx)(n.a,{href:"https://github.com/osbuild/otk/tree/main/example",children:"example omnifests"})," for various distributions and images in a ",(0,s.jsx)(n.a,{href:"/docs/developer-guide/projects/otk/installation",children:"source checkout"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"otkversion",children:(0,s.jsx)(n.code,{children:"otk.version"})}),"\n",(0,s.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'otk.version: "1"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"otktargetconsumername",children:(0,s.jsx)(n.code,{children:"otk.target.<consumer>.<name>"})}),"\n",(0,s.jsxs)(n.p,{children:["Only act on this sub-tree if producing output for the specified consumer. Anything specific to the pipelines of e.g. osbuild would be put under ",(0,s.jsx)(n.code,{children:"otk.target.osbuild"}),". This allows ",(0,s.jsx)(n.code,{children:"otk"})," to infer context for the omnifest that is being processed."]}),"\n",(0,s.jsxs)(n.p,{children:["A target is necessary for ",(0,s.jsx)(n.code,{children:"otk"})," to generate any outputs. The target is namespaced to a specific application. ",(0,s.jsx)(n.code,{children:"otk"})," tries to keep little context but it does need to know what it is outputting for. This allows us to scope ",(0,s.jsx)(n.a,{href:"#otkexternal",children:"otk.external"})," things to only be allowed within specific targets and for those externals to assume certain things will be in the tree."]}),"\n",(0,s.jsxs)(n.p,{children:["The following values are valid for the ",(0,s.jsx)(n.code,{children:"<consumer>"})," part of the key, this list can grow as other image build tooling is supported:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"osbuild"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"<name>"})," part of the key is free form and allows you to use a descriptive name for the export. Note that there MUST be no duplication of the ",(0,s.jsx)(n.code,{children:"<consumer>.<name>"})," tuple."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"otk.target.osbuild.tree:\n  pipelines:\n    - otk.include: pipelines/root.yaml\n    - otk.include: pipelines/tree.yaml\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"otkdefine",children:(0,s.jsx)(n.code,{children:"otk.define"})}),"\n",(0,s.jsxs)(n.p,{children:["Defines variables that can be used through the ",(0,s.jsx)(n.code,{children:"${}"})," directive in\nother parts of the omnifest."]}),"\n",(0,s.jsxs)(n.p,{children:["Variable scope is global, an ",(0,s.jsx)(n.code,{children:"otk.define"})," directive anywhere in the omnifest\ntree will result in the defined names being hoisted to the global scope."]}),"\n",(0,s.jsxs)(n.p,{children:["Redefinitions of variables are allowed. This allows for setting up default\nvalues. If ",(0,s.jsx)(n.code,{children:"-W duplicate-definition"})," is passed as an argument to ",(0,s.jsx)(n.code,{children:"otk"})," then\n",(0,s.jsx)(n.code,{children:"otk"})," will warn on all duplicate definitions."]}),"\n",(0,s.jsxs)(n.p,{children:["Expects a ",(0,s.jsx)(n.code,{children:"map"})," for its value."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"otk.define:\n  packages:\n    include:\n      - @core\n      - kernel\n    exclude:\n      - linux-util\n  boot_mode: uefi\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Valid variable names must start with ",(0,s.jsx)(n.code,{children:"[a-zA-Z]"})," and after that initial\nchar can also contain ",(0,s.jsx)(n.code,{children:"[a-zA-Z0-9_]"}),". E.g. ",(0,s.jsx)(n.code,{children:"foo"})," is valid but ",(0,s.jsx)(n.code,{children:"f?"})," is\nnot."]}),"\n",(0,s.jsxs)(n.h2,{id:"usage-of-",children:["Usage of ",(0,s.jsx)(n.code,{children:"${}"})]}),"\n",(0,s.jsxs)(n.p,{children:["Use a previously defined variable. String values can be used inside other\nstring values, non-string values ",(0,s.jsx)(n.em,{children:"must"})," stand on their own."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'otk.define:\n  variable: "foo"\n\notk.include: ${variable}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Using the above ",(0,s.jsx)(n.code,{children:"packages"})," map example you can refer to the include and exclude\nlists using ",(0,s.jsx)(n.code,{children:"${packages.include}"})," and ",(0,s.jsx)(n.code,{children:"${packages.exclude}"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["If a ",(0,s.jsx)(n.code,{children:"${}"})," appears in a ",(0,s.jsx)(n.code,{children:"str"})," value then its string value as it appears\nin ",(0,s.jsx)(n.code,{children:"otk.define"})," is replaced into the string. Note that substitutions\nin this form require the value to be a string in the ",(0,s.jsx)(n.code,{children:"otk.define"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# this is OK\notk.define:\n  variable: aarch64\n\notk.include: path/${variable}.yaml\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The following example is an error as the value of ",(0,s.jsx)(n.code,{children:"variable"})," is a ",(0,s.jsx)(n.code,{children:"seq"}),", which\nis not allowed inside a string format."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# this is NOT OK\notk.define:\n  variable:\n    - 1\n    - 2\n\notk.include: path/${variable}.yaml\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This is okay because ",(0,s.jsx)(n.code,{children:"${variable}"})," is there on it's own so it's unambiguous."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# this is OK\notk.define:\n  variable:\n    - 1\n    - 2\n\nsome:\n thing: ${variable}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"otkinclude",children:(0,s.jsx)(n.code,{children:"otk.include"})}),"\n",(0,s.jsx)(n.p,{children:"Include a file at this position in the tree, replacing the directive with the\ncontents of the file."}),"\n",(0,s.jsx)(n.p,{children:"Note that cyclical includes are forbidden and will cause an error."}),"\n",(0,s.jsxs)(n.p,{children:["It expects a ",(0,s.jsx)(n.code,{children:"str"})," for its value and as with other strings variable substitution\nis performed before using it."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"otk.include: file.yaml\n"})}),"\n",(0,s.jsx)(n.h2,{id:"otkop",children:(0,s.jsx)(n.code,{children:"otk.op"})}),"\n",(0,s.jsx)(n.p,{children:"Perform various operations on variables."}),"\n",(0,s.jsx)(n.h3,{id:"otkopjoin",children:(0,s.jsx)(n.code,{children:"otk.op.join"})}),"\n",(0,s.jsxs)(n.p,{children:["Join two or more variables of type ",(0,s.jsx)(n.code,{children:"sequence"})," or ",(0,s.jsx)(n.code,{children:"map"})," together, trying to\njoin other types or mix types will cause an error. Duplicate keys in\nmaps are considered an error."]}),"\n",(0,s.jsxs)(n.p,{children:["Expects a ",(0,s.jsx)(n.code,{children:"map"})," for its value that contains a ",(0,s.jsx)(n.code,{children:"values"})," key with a value of type\n",(0,s.jsx)(n.code,{children:"seq"})," or ",(0,s.jsx)(n.code,{children:"map"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Example when using with a ",(0,s.jsx)(n.code,{children:"sequence"})," as input:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"otk.define:\n  a:\n    - 1\n    - 2\n  b:\n    - 3\n    - 4\n  c:\n    otk.op.join:\n      values:\n        - ${a}\n        - ${b}\n\n-> Result c: [1, 2, 3, 4]\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Example when using with a ",(0,s.jsx)(n.code,{children:"map"})," as input:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"otk.define:\n  a:\n    a: 1\n  b:\n    b: 2\n  c:\n    otk.op.join:\n      values:\n        - ${a}\n        - ${b}\n\n-> Result\n  c:\n   a: 1\n   b: 2\n"})}),"\n",(0,s.jsx)(n.h2,{id:"otkexternal",children:(0,s.jsx)(n.code,{children:"otk.external"})}),"\n",(0,s.jsxs)(n.p,{children:["External directives. Directives starting with ",(0,s.jsx)(n.code,{children:"otk.external"})," are redirected\nto ",(0,s.jsx)(n.code,{children:"/usr/libexec/otk/external"}),"-binaries. For example the directive\n",(0,s.jsx)(n.code,{children:"otk.external.osbuild-depsolve-dnf4"})," will execute ",(0,s.jsx)(n.code,{children:"osbuild-depsolve-dnf4"}),"\nwith the tree under the directive on stdin and expect a new tree to replace\nthe directive with on stdout."]}),"\n",(0,s.jsxs)(n.p,{children:["Read more about ",(0,s.jsx)(n.a,{href:"/docs/developer-guide/projects/otk/omnifest/external",children:"external directives"})," in their specific\ndocumentation section."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>d});var t=i(6540);const s={},o=t.createContext(s);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);